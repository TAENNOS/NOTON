name: noton-prod

# 사용법:
#   docker compose -f infra/docker/docker-compose.prod.yml \
#     --env-file infra/docker/.env.prod up -d

services:
  # ── PostgreSQL ───────────────────────────────────────────────────────────────
  postgres:
    image: pgvector/pgvector:pg16
    container_name: noton-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-dbs.sql:/docker-entrypoint-initdb.d/init-dbs.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 10

  # ── Redis ────────────────────────────────────────────────────────────────────
  redis:
    image: redis:7-alpine
    container_name: noton-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── NATS ─────────────────────────────────────────────────────────────────────
  nats:
    image: nats:2-alpine
    container_name: noton-nats
    restart: unless-stopped
    command: -js -m 8222
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8222/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ── MinIO ────────────────────────────────────────────────────────────────────
  minio:
    image: minio/minio:latest
    container_name: noton-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ACCESS_KEY}
      MINIO_ROOT_PASSWORD: ${MINIO_SECRET_KEY}
    ports:
      - "9000:9000"   # API (presigned URL용 외부 노출)
      - "9001:9001"   # Console
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ── Ollama ───────────────────────────────────────────────────────────────────
  ollama:
    image: ollama/ollama:latest
    container_name: noton-ollama
    restart: unless-stopped
    volumes:
      - ollama_data:/root/.ollama

  # ── n8n ──────────────────────────────────────────────────────────────────────
  n8n:
    image: n8nio/n8n:latest
    container_name: noton-n8n
    restart: unless-stopped
    environment:
      N8N_BASIC_AUTH_ACTIVE: "true"
      N8N_BASIC_AUTH_USER: ${N8N_USER}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_PASSWORD}
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: noton_n8n
      DB_POSTGRESDB_USER: ${POSTGRES_USER}
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5678:5678"
    volumes:
      - n8n_data:/home/node/.n8n
    depends_on:
      postgres:
        condition: service_healthy

  # ── DB 마이그레이션 (일회성 실행 후 종료) ────────────────────────────────────
  migrate-identity:
    build:
      context: ../..
      dockerfile: apps/identity/Dockerfile
      target: builder
    command: sh -c "./node_modules/.bin/prisma migrate deploy --schema=apps/identity/prisma/schema.prisma"
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/noton_identity
    depends_on:
      postgres:
        condition: service_healthy
    restart: "no"

  migrate-docs:
    build:
      context: ../..
      dockerfile: apps/docs/Dockerfile
      target: builder
    command: sh -c "./node_modules/.bin/prisma migrate deploy --schema=apps/docs/prisma/schema.prisma"
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/noton_docs
    depends_on:
      postgres:
        condition: service_healthy
    restart: "no"

  migrate-chat:
    build:
      context: ../..
      dockerfile: apps/chat/Dockerfile
      target: builder
    command: sh -c "./node_modules/.bin/prisma migrate deploy --schema=apps/chat/prisma/schema.prisma"
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/noton_chat
    depends_on:
      postgres:
        condition: service_healthy
    restart: "no"

  migrate-files:
    build:
      context: ../..
      dockerfile: apps/files/Dockerfile
      target: builder
    command: sh -c "./node_modules/.bin/prisma migrate deploy --schema=apps/files/prisma/schema.prisma"
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/noton_files
    depends_on:
      postgres:
        condition: service_healthy
    restart: "no"

  migrate-automation:
    build:
      context: ../..
      dockerfile: apps/automation/Dockerfile
      target: builder
    command: sh -c "./node_modules/.bin/prisma migrate deploy --schema=apps/automation/prisma/schema.prisma"
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/noton_automation
    depends_on:
      postgres:
        condition: service_healthy
    restart: "no"

  migrate-assistant:
    build:
      context: ../..
      dockerfile: apps/assistant/Dockerfile
      target: builder
    command: sh -c "./node_modules/.bin/prisma migrate deploy --schema=apps/assistant/prisma/schema.prisma"
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/noton_assistant
    depends_on:
      postgres:
        condition: service_healthy
    restart: "no"

  migrate-notifications:
    build:
      context: ../..
      dockerfile: apps/notifications/Dockerfile
      target: builder
    command: sh -c "./node_modules/.bin/prisma migrate deploy --schema=apps/notifications/prisma/schema.prisma"
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/noton_notifications
    depends_on:
      postgres:
        condition: service_healthy
    restart: "no"

  # ── 애플리케이션 서비스 ───────────────────────────────────────────────────────
  gateway:
    build:
      context: ../..
      dockerfile: apps/gateway/Dockerfile
    container_name: noton-gateway
    restart: unless-stopped
    environment:
      NATS_URL: nats://nats:4222
      JWT_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      GATEWAY_PORT: 3000
    depends_on:
      nats:
        condition: service_healthy

  identity:
    build:
      context: ../..
      dockerfile: apps/identity/Dockerfile
    container_name: noton-identity
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/noton_identity
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      NATS_URL: nats://nats:4222
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: 15m
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      JWT_REFRESH_EXPIRES_IN: 7d
      PORT: 3001
    depends_on:
      migrate-identity:
        condition: service_completed_successfully
      nats:
        condition: service_healthy

  docs:
    build:
      context: ../..
      dockerfile: apps/docs/Dockerfile
    container_name: noton-docs
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/noton_docs
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      NATS_URL: nats://nats:4222
      JWT_SECRET: ${JWT_SECRET}
      PORT: 3002
    depends_on:
      migrate-docs:
        condition: service_completed_successfully
      nats:
        condition: service_healthy

  realtime:
    build:
      context: ../..
      dockerfile: apps/realtime/Dockerfile
    container_name: noton-realtime
    restart: unless-stopped
    environment:
      NATS_URL: nats://nats:4222
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      JWT_SECRET: ${JWT_SECRET}
      PORT: 3003
    depends_on:
      nats:
        condition: service_healthy
      redis:
        condition: service_healthy

  chat:
    build:
      context: ../..
      dockerfile: apps/chat/Dockerfile
    container_name: noton-chat
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/noton_chat
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      NATS_URL: nats://nats:4222
      JWT_SECRET: ${JWT_SECRET}
      PORT: 3004
    depends_on:
      migrate-chat:
        condition: service_completed_successfully
      nats:
        condition: service_healthy

  files:
    build:
      context: ../..
      dockerfile: apps/files/Dockerfile
    container_name: noton-files
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/noton_files
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      NATS_URL: nats://nats:4222
      JWT_SECRET: ${JWT_SECRET}
      # MinIO: presigned URL은 클라이언트가 접근 가능한 공개 주소 사용
      MINIO_ENDPOINT: http://${SERVER_IP}:9000
      MINIO_PORT: 9000
      MINIO_USE_SSL: "false"
      MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY}
      MINIO_SECRET_KEY: ${MINIO_SECRET_KEY}
      MINIO_BUCKET: ${MINIO_BUCKET}
      PORT: 3005
    depends_on:
      migrate-files:
        condition: service_completed_successfully
      minio:
        condition: service_healthy

  automation:
    build:
      context: ../..
      dockerfile: apps/automation/Dockerfile
    container_name: noton-automation
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/noton_automation
      NATS_URL: nats://nats:4222
      JWT_SECRET: ${JWT_SECRET}
      N8N_BASE_URL: http://n8n:5678
      PORT: 3006
    depends_on:
      migrate-automation:
        condition: service_completed_successfully
      nats:
        condition: service_healthy

  assistant:
    build:
      context: ../..
      dockerfile: apps/assistant/Dockerfile
    container_name: noton-assistant
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/noton_assistant
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      NATS_URL: nats://nats:4222
      JWT_SECRET: ${JWT_SECRET}
      OLLAMA_HOST: http://ollama:11434
      OLLAMA_MODEL: ${OLLAMA_MODEL}
      PORT: 3007
    depends_on:
      migrate-assistant:
        condition: service_completed_successfully
      nats:
        condition: service_healthy

  notifications:
    build:
      context: ../..
      dockerfile: apps/notifications/Dockerfile
    container_name: noton-notifications
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/noton_notifications
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      NATS_URL: nats://nats:4222
      JWT_SECRET: ${JWT_SECRET}
      PORT: 3008
    depends_on:
      migrate-notifications:
        condition: service_completed_successfully
      nats:
        condition: service_healthy

  worker:
    build:
      context: ../..
      dockerfile: apps/worker/Dockerfile
    container_name: noton-worker
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/noton_assistant
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      NATS_URL: nats://nats:4222
      OLLAMA_BASE_URL: http://ollama:11434
      OLLAMA_EMBED_MODEL: nomic-embed-text
      NODE_ENV: production
      PORT: 3009
    depends_on:
      migrate-assistant:
        condition: service_completed_successfully
      nats:
        condition: service_healthy

  # ── Nginx (리버스 프록시 + Flutter Web) ─────────────────────────────────────
  nginx:
    image: nginx:alpine
    container_name: noton-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx.prod.conf:/etc/nginx/nginx.conf:ro
      - ../../apps/web/build/web:/usr/share/nginx/html:ro
    depends_on:
      - gateway
      - realtime

volumes:
  postgres_data:
  redis_data:
  minio_data:
  ollama_data:
  n8n_data:
